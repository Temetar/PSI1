#!/usr/bin/env python3
from lxml import etree
from tidylib import tidy_document
from pathlib import Path
from copy import deepcopy

##### Settings #####
hybrid_id = 1 #Port on the fc7, starting at 0
num_chips = 3 #Number of chips
chip_ids = range(num_chips) #Ids of the chips, default is range(num_chips)
uri = "chtcp-2.0://localhost:10203?target=192.168.1.80:50001" #check if ip is correct
####################

parser = etree.XMLParser(remove_blank_text=True)
tag = etree.parse("base.xml",parser)
Hybrid = tag.find(".//Hybrid")
Hybrid.set("Id", str(hybrid_id))
connection = tag.find(".//connection")
connection.set("uri", str(uri))

chip = etree.parse("chip.xml",parser)
chip_element = chip.find("RD53")
for i in range(num_chips):
    chip_element.set("Id", str(chip_ids[i]))
    chip_element.set("Lane", str(chip_ids[i]))
    Hybrid.insert(i+1,deepcopy(chip_element))

tag.write("CMSIT_autogenerated.xml",pretty_print=True)

Result = Path("CMSIT_autogenerated.xml").read_text()
document, errors = tidy_document(Result, options={'indent':'auto','indent-attributes':'yes', 'input-xml':'yes'})
Path("CMSIT_autogenerated.xml").write_text(document)